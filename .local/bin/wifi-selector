#!/bin/bash

ask_for_password()
{
	for i in {1..3}; do
		PASSWORD=$(rofi -password -dmenu -p "Enter password:" -theme applauncher)

		nmcli connection delete "$SELECTED"
		if nmcli d w c "$SELECTED" password "$PASSWORD";
		then
			break
		fi

		# Quit immediately if user didn't input anything
		if [ -z "${PASSWORD}" ];
		then
			break
		fi
	done
}

nmcli d w rescan
NETWORKS=$(nmcli -t -f SSID,SIGNAL dev wifi | grep -v '^:')
# sed 's/^:/<hidden>:/' can rename hidden networks to <hidden> instead

# Removing duplicates
NETWORKS=$(echo "$NETWORKS" | awk -F: '!seen[$1]++')

# Formatting the signal value
NETWORKS=$(echo "$NETWORKS" | awk -F: '{printf "%-42s %8s\n", $1, " (" $2 "/100)"}')

SELECTED=$(echo "$NETWORKS" | rofi -dmenu -i -p "Select network:" -theme applauncher)

# Exit if user quit before selection
if [[ $? -ne 0 ]]; 
then
	exit 0
fi

# Try to connect with no/saved password
# If it doesn't work ask for password
if ! nmcli d w c "$SELECTED";
then
		ask_for_password
fi
